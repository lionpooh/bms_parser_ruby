require "./refine_log.rb"

log_before = "T/000000/B/07031E0000030100/2B030A00E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDC0F/DB0FDC0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD90FD90FD90F/D90FD90FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/07031E0000030100/2B030A00E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDC0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD80FD90FD90F/D90FD90FD90FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/07031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDC0F/DC0FDB0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD80FD90FD90F/D90FDB0FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/07031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDC0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD80FD90FD90F/D90FDB0FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/07031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDC0FDB0F/DC0FDC0FDC0FDC0F/DC0FDC0FDB0FD80F/D80FD90FD90FD90F/DB0FD90FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/07031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDB0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD80FD80FD90F/D90FD90FD90FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/06031E0000030100/2B030A00E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDB0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD80FD80FD90F/D90FD90FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/06031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DC0FDC0FDC0FDC0F/DC0FDC0FDB0FD80F/D80FD80FD80FD90F/D90FD90FD90FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/06031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDB0FDC0FDC0F/DC0FDC0FD90FD90F/D80FD80FD90FD90F/D90FD90FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/06031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDB0FDC0FDC0F/DC0FDC0FD90FD90F/D80FD80FD90FD90F/D90FD90FD90FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/06031E0000030100/2B030A00E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDC0F/DB0FDB0FDC0FDC0F/DC0FDC0FDB0FD90F/D80FD80FD80FD80F/D90FD90FDB0FDB0F/2124212400000000/G/00.000000/000.000000/T/000000/B/06031E0000030100/2B030000E8030000/2421232200000000/0000000000000000/0000000000000000/DB0FDB0FDB0FDB0F/DB0FDB0FDC0FDC0F/DC0FDC0FDB0FD80F/D80FD80FD80FD90F/D90FD90FDB0FDB0F/2124212400000000/G/00.000000/000.000000/ETXETXETX\r\n"

log_new = "T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE10FE10F|E20FE10FE10FE10F|E20FE20FDF0FDF0F|DF0FDF0FE10FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE10FE10F|E10FE10FE20FE20F|E20FE10FDF0FDF0F|DF0FDF0FE10FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE20FE20F|E20FE20FE10FE10F|E20FE10FDF0FDF0F|DF0FDF0FE10FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE20FE10FE20F|E20FE20FE10FE10F|E10FE10FDF0FDF0F|DF0FDF0FE10FE10F|E10FE20FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030A00E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE20FE10F|E20FE20FE10FE10F|E10FE10FDF0FDF0F|DF0FDF0FE10FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE20FE10F|E20FE10FE20FE20F|E10FE10FDF0FDF0F|DF0FDF0FE10FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE20FE10FE20F|E10FE10FE10FE10F|E20FE10FDF0FDF0F|DF0FDF0FE10FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE10FE10F|E10FE20FE20FE20F|E20FE10FDF0FDF0F|DF0FDF0FDF0FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE20FE20F|E10FE20FE20FE10F|E20FE10FDF0FDF0F|DF0FDF0FDF0FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2C030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE20FE10F|E10FE10FE20FE20F|E10FE10FDF0FDF0F|DF0FDF0FDF0FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2C030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE10FE10F|E10FE10FE20FE10F|E20FE20FDF0FDF0F|DF0FDF0FDF0FE10F|E10FE10FE10FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|T|000000|B|3103350000030100|2D030000E8030000|211F202000000000|0000000000000000|0000000000000000|E10FE10FE20FE10F|E20FE20FE20FE20F|E20FE20FDF0FDF0F|DF0FDF0FDF0FE10F|E10FE10FE20FE20F|201F1F2100000000|G|3rkKvb5MYP5K60FQIVp/Lg==|C3NOHmRczH4UzC2ZzaYbVg==|ETXETXETX\r\n"

# now = Time.new
# result = now.strftime("%Y-%m-%dT%H:%M:%S.%3N");

# puts result

# --- --- --- --- 

bms_log_regex = /T\|\d{6}\|B\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|G\|.+?\|.+?\|/

bms_log_group_regex = /T\|(\d{6})\|B\|([\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16}\|[\d|a-f|A-F]{16})\|G\|(.+?\|.+?)\|/

bms_log_regex_old = /T\/\d{6}\/B\/.+?\/G\/\d+.\d+\/\d+.\d+\//

bms_log_group_regex_old = /T\/(\d{6})\/B\/(.+?)\/G\/(\d+.\d+\/\d+.\d+)\//

log_refine_list = []

# battery_log = event.get("battery_log")
battery_log = log_new
log_list = battery_log.scan(bms_log_regex)

now = Time.new
time_size = (log_list.size) * 10
start_time = now.to_i - time_size

log_list.each { |log|
  time, bms, gps = log.match(bms_log_group_regex).captures
  time = start_time;
  start_time += 10;
  
  bms = RefineLog.refine_bms(bms)
  gps = RefineLog.refine_gps(gps)

  log_refine = { "log" => log, "time" => Time.at(time), "bms" => bms, "gps" => gps }
  log_refine_list << log_refine

}

# puts log_refine_list[0]["gps"]
